name: Assign Random Reviewer (with issue history)

on:
  pull_request:
    types: [opened, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  CANDIDATES: ${{ secrets.REVIEWER_CANDIDATES }} # "alice,bob,charlie,danielle" ê°™ì€ GitHub ë¡œê·¸ì¸ ID ëª©ë¡

jobs:
  pick-reviewer:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install jq (for parsing)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Gather linked issues via GraphQL (closing refs + connected events)
        id: linked
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # GraphQL: closingIssuesReferences + ConnectedEvent(Development íŒ¨ë„ ìˆ˜ë™ ë§í¬)
          QUERY='
          query($owner:String!, $name:String!, $number:Int!){
            repository(owner:$owner, name:$name){
              pullRequest(number:$number){
                number
                closingIssuesReferences(first: 50){
                  nodes { number }
                }
                timelineItems(itemTypes: [CONNECTED_EVENT], first: 100){
                  nodes {
                    ... on ConnectedEvent {
                      subject {
                        __typename
                        ... on Issue { number }
                      }
                    }
                  }
                }
              }
            }
          }'
          RESP=$(gh api graphql -f owner="$OWNER" -f name="$REPO" -F number="$PR_NUMBER" -f query="$QUERY")

          # closingIssuesReferences
          CLOSING=$(echo "$RESP" | jq -r '.data.repository.pullRequest.closingIssuesReferences.nodes[].number // empty')

          # ConnectedEvent ì—ì„œ Issueë§Œ ì¶”ì¶œ
          CONNECTED=$(echo "$RESP" | jq -r '.data.repository.pullRequest.timelineItems.nodes[]
            | select(.subject.__typename=="Issue") | .subject.number // empty')

          # ì¤‘ë³µ ì œê±°í•˜ì—¬ ISSUE_LISTë¡œ í•©ì¹˜ê¸°
          ISSUE_LIST=$( (echo "$CLOSING"; echo "$CONNECTED") | awk 'NF' | sort -n | uniq | tr '\n' ' ' )
          echo "issues=$ISSUE_LIST"
          echo "issues=$ISSUE_LIST" >> "$GITHUB_OUTPUT"

      - name: Select reviewer (exclude author, existing, and recent from linked issue comments)
        id: select
        env:
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          AUTHOR: ${{ github.actor }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CANDIDATES: ${{ env.CANDIDATES }}
          ISSUES: ${{ steps.linked.outputs.issues }}
        run: |
          if [ -z "$CANDIDATES" ]; then
            echo "âŒ REVIEWER_CANDIDATES secretì´ ë¹„ì—ˆìŠµë‹ˆë‹¤."
            exit 1
          fi

          # 1) ê¸°ë³¸ ì œì™¸ ëª©ë¡: PR ì‘ì„±ì + ì´ë¯¸ ìš”ì²­ëœ ë¦¬ë·°ì–´
          EXISTING=$(jq -r '.pull_request.requested_reviewers[].login // empty' "$GITHUB_EVENT_PATH")

          # 2) ì—°ê²°ëœ ì´ìŠˆ ì½”ë©˜íŠ¸ì—ì„œ ìµœê·¼ ë¦¬ë·°ì–´ ì¶”ì¶œ (ì ‘ë‘ì–´ ê¸°ì¤€)
          #    í˜•ì‹: "ğŸ¤– auto-assign: @login for PR #123 (YYYY-MM-DD)"
          RECENT=""
          for i in $ISSUES; do
            # ìµœê·¼ Nê°œë§Œ(ì˜ˆ: 50) í›‘ì–´ì„œ ë¶€ë‹´ ì¤„ì´ê¸°
            COMMENTS=$(gh api "repos/$OWNER/$REPO/issues/$i/comments?per_page=50")
            HITS=$(echo "$COMMENTS" \
              | jq -r '.[].body // ""' \
              | grep -Eo "ğŸ¤– auto-assign: @[A-Za-z0-9-]+ " \
              | sed -E "s/.*@([A-Za-z0-9-]+).*/\1/")
            if [ -n "$HITS" ]; then
              RECENT="$RECENT"$'\n'"$HITS"
            fi
          done

          # 3) í›„ë³´ì—ì„œ ì œì™¸ ì²˜ë¦¬
          FILTERED=$(echo "$CANDIDATES" \
            | tr ',' '\n' \
            | grep -v -x "$AUTHOR" \
            | grep -v -xF -f <(echo "$EXISTING" || true) \
            | grep -v -xF -f <(echo "$RECENT" || true) \
            | awk 'NF')

          if [ -z "$FILTERED" ]; then
            echo "âš ï¸ ë‚¨ì€ í›„ë³´ê°€ ì—†ì–´ ë¦¬ë·°ì–´ë¥¼ ë°°ì •í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            exit 0
          fi

          SELECTED=$(echo "$FILTERED" | shuf -n1)
          echo "SELECTED=$SELECTED" >> $GITHUB_ENV
          echo "selected=$SELECTED" >> $GITHUB_OUTPUT
          echo "âœ… ì„ íƒëœ ë¦¬ë·°ì–´: $SELECTED"

      - name: Request reviewer on the PR
        if: env.SELECTED != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          SELECTED: ${{ steps.select.outputs.selected }}
        run: |
          gh api \
            --method POST \
            "repos/$OWNER/$REPO/pulls/$PR_NUMBER/requested_reviewers" \
            -f reviewers[]="$SELECTED"
          echo "ğŸ“ ë¦¬ë·°ì–´ ìš”ì²­ ì™„ë£Œ: @$SELECTED"

      - name: Record assignment into linked issues as comments
        if: env.SELECTED != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          SELECTED: ${{ steps.select.outputs.selected }}
          ISSUES: ${{ steps.linked.outputs.issues }}
        run: |
          DATE=$(date -u +"%Y-%m-%d")
          for i in $ISSUES; do
            BODY="ğŸ¤– auto-assign: @${SELECTED} for PR #${PR_NUMBER} (${DATE})"
            gh api "repos/$OWNER/$REPO/issues/$i/comments" -f body="$BODY" >/dev/null
            echo "ğŸ§¾ ì´ìŠˆ #$i ì½”ë©˜íŠ¸ ê¸°ë¡: $BODY"
          done
